<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wheel Strategy Dashboard</title>
    <style>
        /* Global Styles */
        :root {
            --primary: #3a506b;
            --secondary: #5bc0be;
            --accent: #ffa62b;
            --danger: #e63946;
            --success: #2a9d8f;
            --warning: #f4a261;
            --light: #edf2f4;
            --dark: #1d3557;
            --bg: #f8f9fa;
            --card-bg: #ffffff;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg);
            color: var(--dark);
        }
        
        header {
            background-color: var(--primary);
            color: white;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1rem;
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: 3fr 1fr;
            gap: 1rem;
        }
        
        .main-content {
            display: grid;
            grid-template-rows: auto auto auto;
            gap: 1rem;
        }
        
        .sidebar {
            display: grid;
            grid-template-rows: auto auto;
            gap: 1rem;
        }
        
        .card {
            background-color: var(--card-bg);
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #eee;
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
        }
        
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 0.5rem;
        }
        
        .status-active {
            background-color: var(--success);
        }
        
        .status-warning {
            background-color: var(--warning);
        }
        
        .status-danger {
            background-color: var(--danger);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        table th, table td {
            padding: 0.5rem;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        table th {
            background-color: var(--light);
            color: var(--dark);
        }
        
        .badge {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .badge-success {
            background-color: var(--success);
            color: white;
        }
        
        .badge-warning {
            background-color: var(--warning);
            color: white;
        }
        
        .badge-danger {
            background-color: var(--danger);
            color: white;
        }
        
        .badge-info {
            background-color: var(--secondary);
            color: white;
        }
        
        .metric-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
        }
        
        .metric-card {
            background-color: var(--card-bg);
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            padding: 1rem;
            text-align: center;
            position: relative;
        }
        
        .sample-indicator {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #ff6b35;
            color: white;
            font-size: 10px;
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            z-index: 10;
        }
        
        .metric-card.has-sample-data {
            border: 2px solid #ff6b35;
            background: linear-gradient(135deg, var(--card-bg) 0%, rgba(255, 107, 53, 0.05) 100%);
        }
        
        .metric-value {
            font-size: 1.5rem;
            font-weight: bold;
            margin: 0.5rem 0;
        }
        
        .metric-label {
            font-size: 0.9rem;
            color: #666;
        }
        
        .alert {
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            border-radius: 4px;
            display: flex;
            align-items: center;
        }
        
        .alert-critical {
            background-color: rgba(230, 57, 70, 0.1);
            border-left: 4px solid var(--danger);
        }
        
        .alert-important {
            background-color: rgba(244, 162, 97, 0.1);
            border-left: 4px solid var(--warning);
        }
        
        .alert-info {
            background-color: rgba(91, 192, 190, 0.1);
            border-left: 4px solid var(--secondary);
        }
        
        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .btn-primary {
            background-color: var(--primary);
            color: white;
        }
        
        .btn-secondary {
            background-color: var(--secondary);
            color: white;
        }
        
        .btn-success {
            background-color: var(--success);
            color: white;
        }
        
        .btn-danger {
            background-color: var(--danger);
            color: white;
        }
        
        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
        }
        
        .badge-market {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-weight: bold;
            margin-left: 0.5rem;
        }
        
        .badge-bull {
            background-color: var(--success);
            color: white;
        }
        
        .badge-bear {
            background-color: var(--danger);
            color: white;
        }
        
        .badge-neutral {
            background-color: var(--secondary);
            color: white;
        }
        
        .opportunity-card {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            background-color: rgba(91, 192, 190, 0.1);
            border-radius: 4px;
        }
        
        .opportunity-details {
            flex-grow: 1;
        }
        
        .opportunity-symbol {
            font-weight: bold;
        }
        
        .opportunity-return {
            color: var(--success);
            font-weight: bold;
        }
        
        .date-selector {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .date-selector select {
            margin-left: 0.5rem;
            padding: 0.25rem;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        
        .progress-container {
            width: 100%;
            height: 10px;
            background-color: #eee;
            border-radius: 5px;
            margin-top: 0.5rem;
        }
        
        .progress-bar {
            height: 100%;
            border-radius: 5px;
            background-color: var(--success);
        }
        
        .chart-container {
            height: 200px;
            margin-top: 1rem;
        }
        
        .section-label {
            font-size: 0.8rem;
            color: #666;
            margin-bottom: 0.25rem;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script>
        // Check server status first
        fetch('http://localhost:7001/status')
            .then(response => response.json())
            .then(data => {
                console.log('Server status:', data);
                if (data.status === 'ok') {
                            // Connect to WebSocket with explicit URL and options
        const socket = io(window.location.origin, {
            transports: ['websocket'],
            upgrade: false,
            reconnection: true,
            reconnectionAttempts: Infinity,
            reconnectionDelay: 1000,
            reconnectionDelayMax: 5000,
            timeout: 20000,
            pingInterval: 10000,
            pingTimeout: 5000
        });
        
        // Start ping/pong
        function startPing() {
            setInterval(() => {
                console.log('Sending ping to server');
                socket.emit('ping');
            }, 10000);
        }
                    initializeSocket(socket);
                } else {
                    console.error('Server not ready');
                    document.querySelector('.status-dot').className = 'status-dot status-danger';
                }
            })
            .catch(error => {
                console.error('Error checking server status:', error);
                document.querySelector('.status-dot').className = 'status-dot status-danger';
            });
            
        function initializeSocket(socket) {
                    // Socket.IO connection handling
        socket.on('connect', () => {
            console.log('=== Connected to WebSocket ===');
            console.log('Transport:', socket.io.engine.transport.name);
            console.log('Protocol:', socket.io.engine.protocol);
            console.log('Session ID:', socket.id);
            document.querySelector('.status-dot').className = 'status-dot status-active';
            startPing();  // Start ping/pong when connected
        });
        
        socket.on('disconnect', (reason) => {
            console.log('=== Disconnected from WebSocket ===');
            console.log('Reason:', reason);
            console.log('Transport:', socket.io.engine.transport.name);
            console.log('Session ID:', socket.id);
            document.querySelector('.status-dot').className = 'status-dot status-danger';
        });
        
        socket.on('connect_error', (error) => {
            console.error('=== WebSocket Connection Error ===');
            console.error('Error:', error);
            console.error('Transport:', socket.io.engine ? socket.io.engine.transport.name : 'unknown');
            console.error('Session ID:', socket.id);
            document.querySelector('.status-dot').className = 'status-dot status-danger';
        });
        
        socket.on('error', (error) => {
            console.error('=== Socket.IO Error ===');
            console.error('Error:', error);
            console.error('Transport:', socket.io.engine.transport.name);
            console.error('Session ID:', socket.id);
            document.querySelector('.status-dot').className = 'status-dot status-danger';
        });
        
        socket.on('reconnect_attempt', (attemptNumber) => {
            console.log('=== Attempting to Reconnect ===');
            console.log('Attempt number:', attemptNumber);
            console.log('Transport:', socket.io.engine ? socket.io.engine.transport.name : 'unknown');
            console.log('Session ID:', socket.id);
            document.querySelector('.status-dot').className = 'status-dot status-warning';
        });
        
        socket.on('reconnect', (attemptNumber) => {
            console.log('=== Reconnected ===');
            console.log('After attempts:', attemptNumber);
            console.log('Transport:', socket.io.engine.transport.name);
            console.log('Session ID:', socket.id);
            document.querySelector('.status-dot').className = 'status-dot status-active';
            startPing();  // Restart ping/pong after reconnection
        });
        
        socket.on('pong', () => {
            console.log('=== Received Pong ===');
            console.log('Transport:', socket.io.engine.transport.name);
            console.log('Session ID:', socket.id);
        });
        
        socket.on('status', (data) => {
            console.log('=== Status Update ===');
            console.log('Status:', data);
            console.log('Transport:', socket.io.engine.transport.name);
            console.log('Session ID:', socket.id);
        });
            
            // Handle real-time updates
            socket.on('update', function(data) {
                console.log('Received update:', data);
                document.getElementById('debug-banner').textContent = JSON.stringify(data, null, 2);
                updateDashboard(data);
            });
        }
        
        // Update dashboard with live data
        function updateDashboard(data) {
            console.log('Updating dashboard with data:', data);
            
            // Update positions
            if (data.positions) {
                console.log('Updating positions:', data.positions);
                console.log('Current positions table:', document.querySelector('#positions-table tbody').innerHTML);
                const tbody = document.querySelector('#positions-table tbody');
                tbody.innerHTML = '';
                
                data.positions.forEach(pos => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${pos.symbol}</td>
                        <td>${pos.type}</td>
                        <td>${pos.strike ? '$' + pos.strike.toFixed(2) : '-'}</td>
                        <td>${pos.expiry || '-'}</td>
                        <td>${pos.dte || '-'}</td>
                        <td>${pos.premium ? '$' + pos.premium.toFixed(2) : '-'}</td>
                        <td>
                            <span class="badge ${pos.pnl >= 0 ? 'badge-success' : 'badge-warning'}">
                                ${pos.pnl > 0 ? '+' : ''}${pos.pnl}%
                            </span>
                        </td>
                        <td>${pos.delta || '-'}</td>
                        <td>
                            ${pos.status === 'ROLLING' ? '<button class="btn btn-danger btn-sm">Roll (Defensive)</button>' :
                              pos.status === 'CLOSING' ? '<button class="btn btn-success btn-sm">Close</button>' :
                              pos.status === 'ACTIVE' ? '<button class="btn btn-secondary btn-sm">Monitor</button>' :
                              '<button class="btn btn-primary btn-sm">View</button>'}
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            }
            
            // Update metrics
            if (data.metrics) {
                document.getElementById('account-value').textContent = '$' + data.metrics.account_value.toLocaleString();
                document.getElementById('cash-available').textContent = '$' + data.metrics.available_funds.toLocaleString();
                document.getElementById('cash-percentage').textContent = data.metrics.cash_percentage.toFixed(1) + '% of Portfolio';
                document.getElementById('win-rate').textContent = (data.metrics.win_rate * 100).toFixed(0) + '%';
                document.getElementById('total-return').textContent = (data.metrics.total_return * 100).toFixed(1) + '%';
                document.getElementById('sharpe-ratio').textContent = data.metrics.sharpe_ratio.toFixed(2);
                
                // Update VIX and Regime data
                if (data.metrics.vix_value) {
                    document.getElementById('vix-value').textContent = data.metrics.vix_value.toFixed(1);
                    document.getElementById('vix-percentile').textContent = data.metrics.vix_percentile;
                }
                
                if (data.metrics.regime) {
                    document.getElementById('regime-value').textContent = data.metrics.regime;
                    document.getElementById('regime-strength').textContent = data.metrics.regime_strength || '';
                }
                
                // Update market regime badge
                const regimeBadge = document.getElementById('market-regime');
                regimeBadge.className = 'badge-market ' + 
                    (data.metrics.regime === 'BULLISH' ? 'badge-bull' : 
                     data.metrics.regime === 'BEARISH' ? 'badge-bear' : 
                     'badge-neutral');
                regimeBadge.textContent = data.metrics.regime;
            }
            
            // Update opportunities
            if (data.opportunities) {
                const container = document.getElementById('opportunities-container');
                container.innerHTML = '';
                
                data.opportunities.forEach(opp => {
                    const div = document.createElement('div');
                    div.className = 'opportunity-card';
                    div.innerHTML = `
                        <div class="opportunity-details">
                            <div class="opportunity-symbol">${opp.symbol} $${opp.strike} Put</div>
                            <div>Score: ${opp.score}</div>
                        </div>
                        <div class="opportunity-return">${opp.annual_return.toFixed(1)}% Annualized</div>
                        <button class="btn btn-primary btn-sm">Trade</button>
                    `;
                    container.appendChild(div);
                });
            }
            
            // Update alerts
            if (data.alerts) {
                const container = document.getElementById('alerts-container');
                container.innerHTML = '';
                
                data.alerts.forEach(alert => {
                    const div = document.createElement('div');
                    div.className = `alert alert-${alert.priority.toLowerCase()}`;
                    div.innerHTML = `
                        <div>
                            <strong>${alert.priority}:</strong> ${alert.message}
                        </div>
                        <div style="margin-left: auto;">
                            <button class="btn btn-${alert.priority === 'CRITICAL' ? 'danger' : 
                                                    alert.priority === 'IMPORTANT' ? 'warning' : 
                                                    'secondary'} btn-sm">
                                Take Action
                            </button>
                        </div>
                    `;
                    container.appendChild(div);
                });
            }
            
            // NO FAKE TIMESTAMPS - Only show real server data
            // Last update time will be populated by server or show "No Data"
        }
        
        // Portfolio chart variable
        let portfolioChart = null;
        
        // Initialize portfolio chart
        function initPortfolioChart() {
            const ctx = document.getElementById('portfolio-chart').getContext('2d');
            
            portfolioChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Portfolio Value',
                        data: [],
                        borderColor: '#2a9d8f',
                        backgroundColor: 'rgba(42, 157, 143, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: false,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return 'Value: $' + context.parsed.y.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Update portfolio chart
        function updatePortfolioChart(chartData) {
            if (!portfolioChart || !chartData) return;
            
            const labels = chartData.map(point => {
                const date = new Date(point.date);
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            });
            const values = chartData.map(point => point.value);
            
            portfolioChart.data.labels = labels;
            portfolioChart.data.datasets[0].data = values;
            portfolioChart.update();
        }
        
        // Update sector exposure
        function updateSectorExposure(sectorData) {
            const tbody = document.querySelector('#sector-table tbody');
            if (!tbody || !sectorData) return;
            
            tbody.innerHTML = '';
            
            // Show top 3 non-cash sectors
            const nonCashSectors = sectorData.filter(s => s.sector !== 'Cash').slice(0, 3);
            
            nonCashSectors.forEach(sector => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${sector.sector}</td>
                    <td>
                        <div class="progress-container">
                            <div class="progress-bar" style="width: ${sector.percentage}%;"></div>
                        </div>
                    </td>
                    <td>${sector.percentage}%</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // Update win streak management
        function updateWinStreak(winStreakData) {
            if (!winStreakData) return;
            
            // Update consecutive wins count
            const countElement = document.getElementById('win-streak-count');
            if (countElement) {
                countElement.textContent = winStreakData.consecutive_wins || '0';
            }
            
            // Update win streak message
            const messageElement = document.getElementById('win-streak-message');
            if (messageElement) {
                messageElement.textContent = winStreakData.message || 'Loading...';
            }
            
            // Update risk check
            const riskElement = document.getElementById('win-streak-risk');
            if (riskElement) {
                riskElement.textContent = winStreakData.risk_check || 'Loading...';
            }
            
            // Update alert styling based on risk level
            const alertElement = document.getElementById('win-streak-alert');
            if (alertElement && winStreakData.alert_type) {
                alertElement.className = `alert alert-${winStreakData.alert_type}`;
            }
        }

        // Update opportunities
        function updateOpportunities(opportunitiesData) {
            const container = document.getElementById('opportunities-container');
            if (!container) return;
            
            if (!opportunitiesData || opportunitiesData.length === 0) {
                container.innerHTML = '<div class="section-label">No opportunities found</div>';
                return;
            }
            
            container.innerHTML = '';
            
            opportunitiesData.forEach(opp => {
                const div = document.createElement('div');
                div.className = 'opportunity-card';
                div.innerHTML = `
                    <div class="opportunity-details">
                        <div class="opportunity-symbol">${opp.symbol} $${opp.strike} Put</div>
                        <div>Score: ${opp.score || 0} | Sector: ${opp.sector || 'Unknown'}</div>
                    </div>
                    <div class="opportunity-return">${(opp.annual_return || 0).toFixed(1)}% Annualized</div>
                    <button class="btn btn-primary btn-sm">Trade</button>
                `;
                container.appendChild(div);
            });
        }

        // Update daily workflow
        function updateDailyWorkflow(workflowData) {
            const tbody = document.querySelector('#workflow-table tbody');
            if (!tbody || !workflowData) return;
            
            tbody.innerHTML = '';
            
            workflowData.forEach(item => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${item.name}</td>
                    <td><span class="badge ${item.badge_class}">${item.status.charAt(0).toUpperCase() + item.status.slice(1)}</span></td>
                    <td>${item.time}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // Update income tracking
        function updateIncomeTracking(incomeData) {
            if (!incomeData) return;
            
            // Update monthly target
            const monthlyTargetElement = document.getElementById('monthly-target');
            if (monthlyTargetElement) {
                monthlyTargetElement.textContent = '$' + incomeData.monthly_target.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0});
            }
            
            // Update target percentage
            const targetPercentageElement = document.getElementById('target-percentage');
            if (targetPercentageElement) {
                targetPercentageElement.textContent = incomeData.target_percentage_text;
            }
            
            // Update collected income
            const collectedIncomeElement = document.getElementById('collected-income');
            if (collectedIncomeElement) {
                collectedIncomeElement.textContent = '$' + incomeData.collected_income.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0});
            }
            
            // Update progress text
            const progressTextElement = document.getElementById('progress-text');
            if (progressTextElement) {
                progressTextElement.textContent = incomeData.progress_text;
            }
            
            // Update progress bar
            const progressBarElement = document.getElementById('progress-bar');
            if (progressBarElement) {
                progressBarElement.style.width = incomeData.progress_percentage + '%';
            }
            
            // Update days remaining
            const daysRemainingElement = document.getElementById('days-remaining');
            if (daysRemainingElement) {
                daysRemainingElement.textContent = incomeData.days_remaining + ' days remaining';
            }
        }
        
                             // Update realized P&L metrics
                     function updateRealizedPnl(pnlData) {
                         if (!pnlData) return;
                         
                         // Update Today's P&L
                         const todaysPnlElement = document.getElementById('todays-pnl');
                         const todaysPnlTradesElement = document.getElementById('todays-pnl-trades');
                         const todaysPnlCard = document.getElementById('todays-pnl-card');
                         const todaysPnlSampleIndicator = document.getElementById('todays-pnl-sample-indicator');
                         
                         if (todaysPnlElement && pnlData.todays_pnl) {
                             const pnl = pnlData.todays_pnl.realized_pnl;
                             todaysPnlElement.textContent = `$${pnl.toFixed(2)}`;
                             todaysPnlElement.style.color = pnl >= 0 ? 'var(--success)' : 'var(--danger)';
                             
                             if (todaysPnlTradesElement) {
                                 const trades = pnlData.todays_pnl.trade_count;
                                 const wins = pnlData.todays_pnl.winning_trades;
                                 const losses = pnlData.todays_pnl.losing_trades;
                                 todaysPnlTradesElement.textContent = `${trades} trades (${wins}W/${losses}L)`;
                             }
                             
                             // Handle sample data indicator
                             if (pnlData.todays_pnl.is_sample_data && todaysPnlCard && todaysPnlSampleIndicator) {
                                 todaysPnlCard.classList.add('has-sample-data');
                                 todaysPnlSampleIndicator.style.display = 'block';
                             } else if (todaysPnlCard && todaysPnlSampleIndicator) {
                                 todaysPnlCard.classList.remove('has-sample-data');
                                 todaysPnlSampleIndicator.style.display = 'none';
                             }
                         }
                         
                         // Update MTD P&L
                         const mtdPnlElement = document.getElementById('mtd-pnl');
                         const mtdPnlPercentageElement = document.getElementById('mtd-pnl-percentage');
                         const mtdPnlCard = document.getElementById('mtd-pnl-card');
                         const mtdPnlSampleIndicator = document.getElementById('mtd-pnl-sample-indicator');
                         
                         if (mtdPnlElement && pnlData.mtd_pnl) {
                             const pnl = pnlData.mtd_pnl.realized_pnl;
                             mtdPnlElement.textContent = `$${pnl.toFixed(2)}`;
                             mtdPnlElement.style.color = pnl >= 0 ? 'var(--success)' : 'var(--danger)';
                             
                             if (mtdPnlPercentageElement) {
                                 const percentage = pnlData.mtd_pnl.percentage_of_target;
                                 const trades = pnlData.mtd_pnl.trade_count;
                                 const wins = pnlData.mtd_pnl.winning_trades;
                                 const losses = pnlData.mtd_pnl.losing_trades;
                                 mtdPnlPercentageElement.textContent = `${percentage.toFixed(1)}% of target (${trades} trades)`;
                             }
                             
                             // Handle sample data indicator
                             if (pnlData.mtd_pnl.is_sample_data && mtdPnlCard && mtdPnlSampleIndicator) {
                                 mtdPnlCard.classList.add('has-sample-data');
                                 mtdPnlSampleIndicator.style.display = 'block';
                             } else if (mtdPnlCard && mtdPnlSampleIndicator) {
                                 mtdPnlCard.classList.remove('has-sample-data');
                                 mtdPnlSampleIndicator.style.display = 'none';
                             }
                         }
                     }
        
        // Update decision support and counter
        function updateDecisionSupport(data) {
            if (!data) return;
            
            // Update decision counter metrics
            if (data.decision_summary) {
                const remaining = document.getElementById('decisions-remaining');
                const executed = document.getElementById('decisions-executed');
                const pending = document.getElementById('decisions-pending');
                
                if (remaining) remaining.textContent = data.decision_summary.remaining;
                if (executed) executed.textContent = data.decision_summary.executed;
                if (pending) pending.textContent = data.decision_summary.pending;
                
                // Color code remaining decisions
                if (remaining) {
                    if (data.decision_summary.remaining === 0) {
                        remaining.style.color = 'var(--danger)';
                    } else if (data.decision_summary.remaining <= 1) {
                        remaining.style.color = 'var(--warning)';
                    } else {
                        remaining.style.color = 'var(--success)';
                    }
                }
            }
            
            // Update recent decisions
            if (data.decision_summary && data.decision_summary.recent_decisions) {
                const recentDecisions = document.getElementById('recent-decisions');
                if (recentDecisions) {
                    if (data.decision_summary.recent_decisions.length === 0) {
                        recentDecisions.innerHTML = '<div class="section-label">No decisions today</div>';
                    } else {
                        const decisionsHtml = data.decision_summary.recent_decisions.map(decision => {
                            const statusColor = decision.executed ? 
                                (decision.result === 'SUCCESS' ? 'var(--success)' : 'var(--danger)') : 'var(--warning)';
                            const statusText = decision.executed ? 
                                (decision.result === 'SUCCESS' ? '✓' : '✗') : '⏳';
                            
                            return `
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0; border-bottom: 1px solid #eee;">
                                    <div>
                                        <div style="font-weight: bold;">${decision.symbol} - ${decision.action}</div>
                                        <div style="font-size: 0.8rem; color: #666;">${decision.reason}</div>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="color: ${statusColor}; font-weight: bold;">${statusText}</div>
                                        <div style="font-size: 0.8rem; color: #666;">${decision.time}</div>
                                    </div>
                                </div>
                            `;
                        }).join('');
                        recentDecisions.innerHTML = decisionsHtml;
                    }
                }
            }
            
            // Update decision breakdown
            if (data.decision_breakdown) {
                const breakdown = document.getElementById('decision-breakdown');
                if (breakdown) {
                    const breakdownHtml = `
                        <div style="font-size: 0.9rem;">
                            <div><strong>By Type:</strong> ${Object.entries(data.decision_breakdown.by_type || {}).map(([type, count]) => `${type}: ${count}`).join(', ') || 'None'}</div>
                            <div><strong>By Priority:</strong> ${Object.entries(data.decision_breakdown.by_priority || {}).map(([priority, count]) => `${priority}: ${count}`).join(', ') || 'None'}</div>
                            <div><strong>By Result:</strong> ${Object.entries(data.decision_breakdown.by_result || {}).map(([result, count]) => `${result}: ${count}`).join(', ') || 'None'}</div>
                        </div>
                    `;
                    breakdown.innerHTML = breakdownHtml;
                }
            }
            
            // Update alerts
            if (data.alerts) {
                const alertsContainer = document.getElementById('alerts-container');
                if (alertsContainer) {
                    if (data.alerts.length === 0) {
                        alertsContainer.innerHTML = '<div class="section-label">No alerts at this time</div>';
                    } else {
                        const alertsHtml = data.alerts.map(alert => {
                            const priorityClass = alert.priority === 'critical' ? 'alert-danger' : 
                                                alert.priority === 'warning' ? 'alert-warning' : 
                                                alert.priority === 'important' ? 'alert-info' : 'alert-info';
                            
                            return `
                                <div class="alert ${priorityClass}">
                                    <div><strong>${alert.title}</strong></div>
                                    <div>${alert.message}</div>
                                    ${alert.action_required ? `<div style="font-size: 0.9rem; margin-top: 0.5rem;"><strong>Action:</strong> ${alert.action_required}</div>` : ''}
                                </div>
                            `;
                        }).join('');
                        alertsContainer.innerHTML = alertsHtml;
                    }
                }
            }
        }

        // Hide debug banner once data loads
        function hideDebugBanner() {
            const banner = document.getElementById('debug-banner');
            if (banner) {
                banner.style.display = 'none';
            }
        }

        // Update system status with live data
        function updateSystemStatus() {
            fetch('/status')
                .then(response => response.json())
                .then(data => {
                    // Update main system status
                    const systemStatusDot = document.getElementById('system-status-dot');
                    const systemStatusText = document.getElementById('system-status-text');
                    
                    if (data.ibkr_connected) {
                        systemStatusDot.className = 'status-dot status-active';
                        systemStatusText.textContent = 'System Active';
                    } else {
                        systemStatusDot.className = 'status-dot status-inactive';
                        systemStatusText.textContent = 'System Inactive';
                    }
                    
                    // Update Circuit Breaker status
                    const circuitBreakerStatus = document.getElementById('circuit-breaker-status');
                    if (data.circuit_breaker_active) {
                        circuitBreakerStatus.textContent = 'ACTIVE';
                        circuitBreakerStatus.style.color = 'var(--danger)';
                    } else {
                        circuitBreakerStatus.textContent = 'Inactive';
                        circuitBreakerStatus.style.color = 'var(--success)';
                    }
                    
                    // Update Black Swan Protocol status
                    const blackSwanStatus = document.getElementById('black-swan-status');
                    if (data.black_swan_active) {
                        blackSwanStatus.textContent = 'ACTIVE';
                        blackSwanStatus.style.color = 'var(--danger)';
                    } else {
                        blackSwanStatus.textContent = 'Inactive';
                        blackSwanStatus.style.color = 'var(--success)';
                    }
                    
                    // Update API Connection status
                    const apiConnectionStatus = document.getElementById('api-connection-status');
                    if (data.ibkr_connected) {
                        apiConnectionStatus.textContent = 'Connected';
                        apiConnectionStatus.style.color = 'var(--success)';
                    } else {
                        apiConnectionStatus.textContent = 'Disconnected';
                        apiConnectionStatus.style.color = 'var(--danger)';
                    }
                    
                    // Update seasonal pattern data
                    const earningsSeason = document.getElementById('earnings-season');
                    const seasonalFocus = document.getElementById('seasonal-focus');
                    if (data.earnings_season) {
                        earningsSeason.textContent = `Earnings Season: ${data.earnings_season}`;
                        seasonalFocus.textContent = data.seasonal_focus || 'Loading...';
                    } else {
                        earningsSeason.textContent = 'Loading...';
                        seasonalFocus.textContent = 'Loading...';
                    }
                })
                .catch(error => console.error('Error fetching status:', error));
        }

        // Initial data load
        window.onload = function() {
            // Initialize chart
            initPortfolioChart();
            
            // Update system status
            updateSystemStatus();
            
            // Fetch initial positions
            fetch('/api/positions')
                .then(response => response.json())
                .then(data => {
                    console.log('Initial positions:', data);
                    updateDashboard({ positions: data });
                    hideDebugBanner(); // Hide once we get real data
                })
                .catch(error => console.error('Error fetching positions:', error));
            
            // Fetch initial metrics
            fetch('/api/metrics')
                .then(response => response.json())
                .then(data => {
                    console.log('Initial metrics:', data);
                    updateDashboard({ metrics: data });
                    hideDebugBanner(); // Hide once we get real data
                })
                .catch(error => console.error('Error fetching metrics:', error));
            
            // Fetch portfolio chart data
            fetch('/api/portfolio-chart')
                .then(response => response.json())
                .then(data => {
                    console.log('Portfolio chart data:', data);
                    updatePortfolioChart(data);
                })
                .catch(error => console.error('Error fetching chart data:', error));
            
            // Fetch sector exposure data
            fetch('/api/sector-exposure')
                .then(response => response.json())
                .then(data => {
                    console.log('Sector exposure data:', data);
                    updateSectorExposure(data);
                })
                .catch(error => console.error('Error fetching sector data:', error));
            
            // Fetch win streak data
            fetch('/api/win-streak')
                .then(response => response.json())
                .then(data => {
                    console.log('Win streak data:', data);
                    updateWinStreak(data);
                })
                .catch(error => console.error('Error fetching win streak data:', error));
            
            // Fetch opportunities data
            fetch('/api/opportunities')
                .then(response => response.json())
                .then(data => {
                    console.log('Opportunities data:', data);
                    updateOpportunities(data);
                })
                .catch(error => console.error('Error fetching opportunities data:', error));
            
            // Fetch daily workflow data
            fetch('/api/daily-workflow')
                .then(response => response.json())
                .then(data => {
                    console.log('Daily workflow data:', data);
                    updateDailyWorkflow(data);
                })
                .catch(error => console.error('Error fetching daily workflow data:', error));
            
            // Fetch income tracking data
            fetch('/api/income-tracking')
                .then(response => response.json())
                .then(data => {
                    console.log('Income tracking data:', data);
                    updateIncomeTracking(data);
                })
                .catch(error => console.error('Error fetching income tracking data:', error));
            
            // Fetch realized P&L data
            fetch('/api/realized-pnl')
                .then(response => response.json())
                .then(data => {
                    console.log('Realized P&L data:', data);
                    updateRealizedPnl(data);
                })
                .catch(error => console.error('Error fetching realized P&L data:', error));
            
            // Fetch decision support data
            fetch('/api/decision-support')
                .then(response => response.json())
                .then(data => {
                    console.log('Decision support data:', data);
                    updateDecisionSupport(data);
                })
                .catch(error => console.error('Error fetching decision support data:', error));
            
            // Update system status every 30 seconds
            setInterval(updateSystemStatus, 30000);
        };
    </script>
</head>
<body>
    <header>
        <div class="logo">
            <h1>Wheel Strategy Dashboard</h1>
        </div>
        <div class="status-indicator">
            <div class="status-dot" id="system-status-dot"></div>
            <span id="system-status-text">Loading...</span>
        </div>
    </header>
    <!-- DEBUG BANNER - Hidden by default, shown only during initial loading -->
    <div id="debug-banner" style="background: #ffeeba; color: #856404; padding: 8px; font-size: 0.9rem; border-bottom: 1px solid #ffeeba; font-family: monospace; overflow-x: auto; white-space: pre; display: none;">
        Loading data...
    </div>
    
    <div class="container">
        <div class="dashboard-grid">
            <div class="main-content">
                <!-- Portfolio Overview -->
                <div class="card">
                    <div class="card-header">
                        <h2>Portfolio Overview</h2>
                        <div>
                            <span id="market-regime" class="badge-market badge-neutral">Loading...</span>
                            <span id="last-update" class="section-label">Updated: Loading...</span>
                        </div>
                    </div>
                    
                    <div class="metric-grid">
                        <div class="metric-card">
                            <div class="metric-label">Account Value</div>
                            <div id="account-value" class="metric-value">Loading...</div>
                            <div id="daily-change" class="section-label">--</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Cash Available</div>
                            <div id="cash-available" class="metric-value">Loading...</div>
                            <div id="cash-percentage" class="section-label">--</div>
                        </div>
                                                        <div class="metric-card" id="todays-pnl-card">
                                    <div class="metric-label">Today's P&L</div>
                                    <div id="todays-pnl" class="metric-value">Loading...</div>
                                    <div id="todays-pnl-trades" class="section-label">--</div>
                                    <div id="todays-pnl-sample-indicator" class="sample-indicator" style="display: none;">SAMPLE DATA</div>
                                </div>
                                <div class="metric-card" id="mtd-pnl-card">
                                    <div class="metric-label">MTD P&L</div>
                                    <div id="mtd-pnl" class="metric-value">Loading...</div>
                                    <div id="mtd-pnl-percentage" class="section-label">--</div>
                                    <div id="mtd-pnl-sample-indicator" class="sample-indicator" style="display: none;">SAMPLE DATA</div>
                                </div>
                        <div class="metric-card">
                            <div class="metric-label">Total Return</div>
                            <div id="total-return" class="metric-value">Loading...</div>
                            <div class="section-label">Since Inception</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Sharpe Ratio</div>
                            <div id="sharpe-ratio" class="metric-value">Loading...</div>
                            <div class="section-label">Risk-Adjusted Return</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Win Rate</div>
                            <div id="win-rate" class="metric-value">Loading...</div>
                            <div class="section-label">Last 30 Days</div>
                        </div>
                    </div>
                    
                    <div class="chart-container">
                        <canvas id="portfolio-chart"></canvas>
                    </div>
                </div>
                
                <!-- Active Positions -->
                <div class="card">
                    <div class="card-header">
                        <h2>Active Positions</h2>
                        <div>
                            <button class="btn btn-secondary btn-sm" onclick="window.location.reload()">Refresh</button>
                        </div>
                    </div>
                    
                    <table id="positions-table">
                        <thead>
                            <tr>
                                <th>Symbol</th>
                                <th>Type</th>
                                <th>Strike</th>
                                <th>Expiry</th>
                                <th>DTE</th>
                                <th>Premium</th>
                                <th>P&L %</th>
                                <th>Delta</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="9" style="text-align: center;">Loading positions...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- Decision Support -->
                <div class="card">
                    <div class="card-header">
                        <h2>Decision Support</h2>
                    </div>
                    
                    <div id="alerts-container" style="margin-bottom: 1rem;">
                        <div class="section-label">Loading alerts...</div>
                    </div>
                </div>
                
                <!-- Decision Counter -->
                <div class="card">
                    <div class="card-header">
                        <h2>Daily Decision Counter</h2>
                    </div>
                    
                    <div class="metric-grid">
                        <div class="metric-card">
                            <div class="metric-label">Remaining</div>
                            <div id="decisions-remaining" class="metric-value">Loading...</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Executed</div>
                            <div id="decisions-executed" class="metric-value">Loading...</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Pending</div>
                            <div id="decisions-pending" class="metric-value">Loading...</div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 1rem;">
                        <div class="section-label">Recent Decisions</div>
                        <div id="recent-decisions" style="max-height: 200px; overflow-y: auto;">
                            <div class="section-label">Loading recent decisions...</div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 1rem;">
                        <div class="section-label">Decision Breakdown</div>
                        <div id="decision-breakdown">
                            <div class="section-label">Loading breakdown...</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="sidebar">
                <!-- Market Conditions -->
                <div>
                    <div class="card">
                        <div class="card-header">
                            <h2>Market Conditions</h2>
                        </div>
                        
                        <div class="metric-grid">
                            <div class="metric-card">
                                <div class="metric-label">VIX</div>
                                <div id="vix-value" class="metric-value">Loading...</div>
                                <div id="vix-percentile" class="section-label">--</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-label">Regime</div>
                                <div id="regime-value" class="metric-value">Loading...</div>
                                <div id="regime-strength" class="section-label">--</div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 1rem;">
                            <div class="section-label">Sector Exposure (Top 3)</div>
                            <table id="sector-table">
                                <tbody>
                                    <tr>
                                        <td colspan="3" style="text-align: center;">Loading sector data...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <div style="margin-top: 1rem;">
                            <div class="section-label">Seasonal Pattern</div>
                            <div id="earnings-season" style="font-weight: bold;">Loading...</div>
                            <div id="seasonal-focus">Loading...</div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h2>Win Streak Management</h2>
                        </div>
                        
                        <div style="display: flex; align-items: center;">
                            <div id="win-streak-count" style="font-size: 2rem; font-weight: bold; margin-right: 1rem;">Loading...</div>
                            <div>
                                <div>Consecutive Wins</div>
                                <div id="win-streak-message" class="section-label">Loading...</div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 1rem;">
                            <div class="section-label">Risk Check</div>
                            <div id="win-streak-alert" class="alert alert-info">
                                <div>
                                    <strong id="win-streak-risk">Loading...</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h2>Opportunity Scanner</h2>
                        </div>
                        
                        <div id="opportunities-container">
                            <div class="section-label">Loading opportunities...</div>
                        </div>
                        
                        <div style="margin-top: 1rem; text-align: center;">
                            <button class="btn btn-secondary">View All Opportunities</button>
                        </div>
                    </div>
                </div>
                
                <!-- System Status -->
                <div>
                    <div class="card">
                        <div class="card-header">
                            <h2>System Status</h2>
                        </div>
                        
                        <div style="margin-bottom: 1rem;">
                            <div class="metric-grid">
                                <div class="metric-card">
                                    <div class="metric-label">Circuit Breaker</div>
                                    <div class="metric-value" id="circuit-breaker-status">Loading...</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">Black Swan Protocol</div>
                                    <div class="metric-value" id="black-swan-status">Loading...</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">API Connection</div>
                                    <div class="metric-value" id="api-connection-status">Loading...</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">Last Update</div>
                                    <div class="metric-value" id="last-update">NO DATA</div>
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <div class="section-label">Daily Workflow</div>
                            <table id="workflow-table">
                                <tbody>
                                    <tr>
                                        <td colspan="3" style="text-align: center;">Loading workflow status...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h2>Income Tracking</h2>
                        </div>
                        
                        <div class="metric-grid">
                            <div class="metric-card">
                                <div class="metric-label">Monthly Target</div>
                                <div id="monthly-target" class="metric-value">Loading...</div>
                                <div id="target-percentage" class="section-label">Loading...</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-label">Collected</div>
                                <div id="collected-income" class="metric-value">Loading...</div>
                                <div id="progress-text" class="section-label">Loading...</div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 1rem;">
                            <div class="section-label">Progress to Goal</div>
                            <div class="progress-container">
                                <div id="progress-bar" class="progress-bar" style="width: 0%;"></div>
                            </div>
                            <div id="days-remaining" class="section-label" style="text-align: right;">Loading...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>